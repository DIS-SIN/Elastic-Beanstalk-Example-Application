{% extends 'layout.html' %}

{% block head %}
	<!-- Highcharts -->
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<!-- Highcharts drilldown -->
	<script src="https://code.highcharts.com/modules/drilldown.js" async></script>
{% endblock head %}

{% block body %}
	<div class="container">
		<!-- Tabs -->
		<ul class="nav nav-tabs nav-justified main-tabs">
			<li class="active"><a href="#general">{{ _('General') }}</a></li>
			<li><a href="#dashboard">{{ _('Dashboard') }}</a></li>
			<li><a href="#geodata">{{ _('Maps') }}</a></li>
			<li><a href="#comments">{{ _('Comments') }}</a></li>
			<!-- Not wrapping 'P&A' in Babel's underscore func as throws error in IE11 -->
			<li><a href="#material">P&amp;A</a></li>
		</ul>
		
		<!-- Import custom macro for adding 'Download raw data' button -->
		{% from "includes/_formhelpers.html" import download_raw %}
		
		<!-- Tabs' contents -->
		<!-- General -->
		<section id="general" class="active">
			{{ download_raw(url_for('downloads.download_general', course_code=pass_dict.course_code)) }}
			{% include 'course-page/general.html' %}
		</section>
		
		<!-- Dashboard -->
		<section id="dashboard" class="hide">
			{{ download_raw(url_for('downloads.download_dashboard', course_code=pass_dict.course_code)) }}
			{% include 'course-page/dashboard-main.html' %}
		</section>
		
		<!-- Geodata -->
		<section id="geodata" class="hide">
			<!-- Dashboard and Maps tabs built from same table -->
			{{ download_raw(url_for('downloads.download_dashboard', course_code=pass_dict.course_code)) }}
			{% include 'course-page/geodata.html' %}
		</section>
		
		<!-- Level 1 Comments -->
		<section id="comments" class="hide">
			{{ download_raw(url_for('downloads.download_comments', course_code=pass_dict.course_code)) }}
			{% include 'course-page/comments.html' %}
		</section>
		
		<!-- Material i.e. Prep & Admin -->
		<section id="material" class="hide">
			{% include 'course-page/material.html' %}
		</section>
	</div>
	
	<script async>
		// Set font for Highcharts
		Highcharts.setOptions({chart: {style: {fontFamily: 'Helvetica'}}});
		
		// IE11 bug: Charts created in hidden div assigned incorrect width
		function resizeHighcharts(mySection) {
			var currentHighcharts = $(mySection + ' div[data-highcharts-chart]');
			// Loop through charts and resize
			for (var i = 0; i < currentHighcharts.length; i++) {
				$('#' + currentHighcharts[i].id).highcharts().reflow();
			}
		}
		
		// Update tabs' CSS on click
		$('.nav-tabs li').on('click', function() {
			$(this).siblings().removeClass('active');
			$(this).addClass('active');
		});
		
		// Show and hide sections
		$('.nav-tabs li a').click(function(event) {
			event.preventDefault();
			
			// Hide section that's currently active
			var current_section = $(this).parent().siblings('.active').children('a').attr('href');
			$(current_section).removeClass('active');
			$(current_section).addClass('hide');
			
			// Show section whose tab was just clicked
			var new_section = $(this).attr('href');
			$(new_section).removeClass('hide');
			$(new_section).addClass('active');
			
			/* IE11 bug: Create Offerings per Region chart only after its parent
			div is activated, else drilldown functionality won't work */
			if (new_section === '#dashboard' && !offeringPerRegionCreatedFlag) {
				createOfferingsPerRegion();
				offeringPerRegionCreatedFlag++;
			}
			
			resizeHighcharts(new_section);
		});
	</script>
{% endblock body %}
